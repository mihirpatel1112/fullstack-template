---
- name: Add swap space to server
  hosts: all
  become: true

  vars:
    swap_file_path: /swapfile
    swap_file_size_mb: 1024  # 1GB swap

  tasks:
    - name: Create swap file
      command: dd if=/dev/zero of={{ swap_file_path }} bs=1M count={{ swap_file_size_mb }}
      args:
        creates: "{{ swap_file_path }}"
      tags:
        - swap.file.create

    - name: Change swap file permissions
      file:
        path: "{{ swap_file_path }}"
        owner: root
        group: root
        mode: "0600"
      tags:
        - swap.file.permissions

    - name: "Check swap file type"
      command: file {{ swap_file_path }}
      register: swapfile
      tags:
        - swap.file.mkswap

    - name: Make swap file
      command: "mkswap {{ swap_file_path }}"
      when: swapfile.stdout.find('swap file') == -1
      tags:
        - swap.file.mkswap

    - name: Write swap entry in fstab
      mount:
        name: none
        src: "{{ swap_file_path }}"
        fstype: swap
        opts: sw
        passno: 0
        dump: 0
        state: present
      tags:
        - swap.fstab

    - name: Check if swap file is already active
      command: swapon --show
      register: current_swap
      changed_when: false
      tags:
        - swap.file.swapon

    - name: Mount swap
      command: "swapon {{ swap_file_path }}"
      when: swap_file_path not in current_swap.stdout
      tags:
        - swap.file.swapon

    - name: Set swappiness to 10
      sysctl:
        name: vm.swappiness
        value: "10"
        state: present
        sysctl_file: /etc/sysctl.conf

    - name: Verify swap is active
      command: swapon --show
      register: swap_status

    - name: Display swap status
      debug:
        var: swap_status.stdout